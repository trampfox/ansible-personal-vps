---
# Enable and allow everything
- name: Allow everything and enable UFW
  community.general.ufw:
    state: enabled
    policy: deny

- name: Allow all incoming SSH 
  community.general.ufw:
    rule: allow
    proto: tcp
    port: '22'

- name: Allow all incoming HTTPS 
  community.general.ufw:
    rule: allow
    proto: tcp
    port: '443'

# see https://stackoverflow.com/a/54064225
- name: Allow incoming docker0 internal traffic
  community.general.ufw:
    rule: allow
    proto: tcp
    port: '1:65535'
    interface: docker0
    direction: in
    from_ip: 172.17.0.0/16
    to_ip: 172.17.0.0/16

# ufw will deny connections if an IP address has attempted 
# to initiate 6 or more connections in the last 30 seconds.
- name: SSH connection rate limiting
  community.general.ufw:
    rule: limit
    port: '22'
    proto: tcp

- name: HTTPS connection rate limiting
  community.general.ufw:
    rule: limit
    port: '443'
    proto: tcp

- name: Copy docker daemon.json file
  template: 
    src: daemon.json.j2
    dest: /etc/docker/daemon.json"
  when: ufw_disable_docker_iptables

# TODO allow 443 only from cloudflare 